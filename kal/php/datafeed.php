<?phpinclude_once("dbconfig.php");include_once("functions.php");//function addCalendar($st, $et, $sub, $ade){function addCalendar($st, $et, $sub, $sede, $profesor, $salon, $horario, $nivel, $materia){  $ret = array();  try{    $db = new DBConnection();    $db->getConnection();    $sql = "SELECT * FROM jqcalendar WHERE Sede = '$sede' AND Profesor = '$profesor' AND Salon = '$salon' AND Horario = '$horario ' AND Nivel = '$nivel' AND Materia = '$materia' AND StartTime = '$st' AND EndTime = '$et' ;";    $handle = mysql_query($sql);    mysql_query ("SET NAMES 'utf8'");    mysql_set_charset('utf8');    $i=0;    while ($row = mysql_fetch_object($handle))     {      $i++;    }      if($i > 0)    {      $ret = "R";    }    else    {          // aki voy 20171022        include_once('../../Connections/cnn_kn.php');        $insertSQL = "INSERT INTO clases (IdClase, Sede, Profesor, Salon, Horario, Nivel, Materia, FechaGraba, IdEvento, Estado, desde, hasta) VALUES (0, $sede, $profesor, $salon, $horario, $nivel, $materia, Now(), '$st', 1, '$st', '$et');";        mysqli_select_db($cnn_kn, $database_cnn_kn);        $Result1 = mysqli_query($cnn_kn, $insertSQL) or die(mysqli_error()."Err31....$insertSQL<br>");         mysqli_select_db($cnn_kn, $database_cnn_kn);        $query_rs_tipo_amattabla = "SELECT max(IdClase) idclase FROM clases;";        $rs_tipo_amattabla = mysqli_query($cnn_kn,$query_rs_tipo_amattabla) or die(mysqli_error()."$query_rs_tipo_mattabla");        mysqli_set_charset($cnn_kn,"utf8");        $row_rs_tipo_amattabla = mysqli_fetch_assoc($rs_tipo_amattabla);        $totalRows_rs_tipo_amattabla = mysqli_num_rows($rs_tipo_amattabla);        $idclasemax = $row_rs_tipo_amattabla['idclase'];        mysqli_free_result($rs_tipo_amattabla);                         $sql = "INSERT INTO jqcalendar (starttime, endtime, isalldayevent, IdClase, Sede, Salon, Materia, Nivel, Horario, Profesor, Estado, dia, desde, hasta, FechaGraba, IdEvento) VALUES ('"          //.mysql_real_escape_string($sub)."', '"          .php2MySqlTime(js2PhpTime($st))."', '"          .php2MySqlTime(js2PhpTime($et))."', 0, '"          .mysql_real_escape_string($idclasemax)."', '"          .mysql_real_escape_string($sede)."', '"          .mysql_real_escape_string($salon)."', '"          .mysql_real_escape_string($materia)."', '"                    .mysql_real_escape_string($nivel)."', '"          .mysql_real_escape_string($horario)."', '"          .mysql_real_escape_string($profesor)."', 1, 0, '"          .php2MySqlTime(js2PhpTime($st))."', '"          .php2MySqlTime(js2PhpTime($et))."', Now(), '"          .php2MySqlTime(js2PhpTime($st))."' )";        echo($sql);    		if(mysql_query($sql)==false)        {          $ret['IsSuccess'] = false;          $ret['Msg'] = mysql_error();        }        else        {          $ret['IsSuccess'] = true;          $ret['Msg'] = 'Grabado Correctamente.';          $ret['Data'] = mysql_insert_id();        }    }    	}catch(Exception $e){     $ret['IsSuccess'] = false;     $ret['Msg'] = $e->getMessage();  }  return $ret;}//function addDetailedCalendar($st, $et, $sub, $ade, $dscr, $loc, $color, $tz){function addDetailedCalendar($st, $et, $sede, $profesor, $salon, $horario, $nivel, $materia){  $ret = array();  try{        include_once('../../Connections/cnn_kn.php');        $insertSQL = "INSERT INTO clases (IdClase, Sede, Profesor, Salon, Horario, Nivel, Materia, FechaGraba, IdEvento, Estado, desde, hasta) VALUES (0, $sede, $profesor, $salon, $horario, $nivel, $materia, Now(), '$st', 1, '$st', '$et');";        mysqli_select_db($cnn_kn, $database_cnn_kn);        $Result1 = mysqli_query($cnn_kn, $insertSQL) or die(mysqli_error()."Err31....$insertSQL<br>");         mysqli_select_db($cnn_kn, $database_cnn_kn);        $query_rs_tipo_amattabla = "SELECT max(IdClase) idclase FROM clases;";        $rs_tipo_amattabla = mysqli_query($cnn_kn,$query_rs_tipo_amattabla) or die(mysqli_error()."$query_rs_tipo_mattabla");        mysqli_set_charset($cnn_kn,"utf8");        $row_rs_tipo_amattabla = mysqli_fetch_assoc($rs_tipo_amattabla);        $totalRows_rs_tipo_amattabla = mysqli_num_rows($rs_tipo_amattabla);        $idclasemax = $row_rs_tipo_amattabla['idclase'];        mysqli_free_result($rs_tipo_amattabla);         // Para colocar la hora de acuerdo al horario seleccionado        mysqli_select_db($cnn_kn, $database_cnn_kn);        $query_rs_tipo_hora = "SELECT Inicio, Final FROM horario WHERE IdHorario = $horario AND Estado = 1;";        $rs_tipo_hora = mysqli_query($cnn_kn,$query_rs_tipo_hora) or die(mysqli_error()."$query_rs_tipo_mattabla");        mysqli_set_charset($cnn_kn,"utf8");        $row_rs_tipo_hora = mysqli_fetch_assoc($rs_tipo_hora);        $totalRows_rs_tipo_hora = mysqli_num_rows($rs_tipo_hora);        $hInicio = $row_rs_tipo_hora['Inicio'];        $hFinal = $row_rs_tipo_hora['Final'];        mysqli_free_result($rs_tipo_hora);           $st = $st.' '.$hInicio ;        $et = $et.' '.$hFinal ;    $db = new DBConnection();    $db->getConnection();        $sql = "INSERT INTO jqcalendar (starttime, endtime, IdClase, Sede, Salon, Materia, Nivel, Horario, Profesor, Estado, dia, desde, hasta, FechaGraba, IdEvento)  VALUES  ('"            .mysql_real_escape_string($st)."', '"      .mysql_real_escape_string($et)."', '"            .mysql_real_escape_string($idclasemax)."', '"      .mysql_real_escape_string($sede)."', '"      .mysql_real_escape_string($salon)."', '"      .mysql_real_escape_string($materia)."', '"      .mysql_real_escape_string($nivel)."', '"      .mysql_real_escape_string($horario)."', '"      .mysql_real_escape_string($profesor)."', 1, 0, '"      .mysql_real_escape_string($st)."', '"      .mysql_real_escape_string($et)."', Now(), '"      .mysql_real_escape_string($st)."' )";    //echo($sql);		if(mysql_query($sql)==false){      $ret['IsSuccess'] = false;      $ret['Msg'] = mysql_error();    }else{      $ret['IsSuccess'] = true;      $ret['Msg'] = 'Grabado Correctamente.';      $ret['Data'] = mysql_insert_id();    }	}catch(Exception $e){     $ret['IsSuccess'] = false;     $ret['Msg'] = $e->getMessage();  }  return $ret;}function listCalendarByRange($sd, $ed){  $ret = array();  $ret['events'] = array();  $ret["issort"] =true;  $ret["start"] = php2JsTime($sd);  $ret["end"] = php2JsTime($ed);  $ret['error'] = null;  $condi = "";  try{    $db = new DBConnection();    $db->getConnection();        //$sql = "select * from `jqcalendar` where `starttime` between '"    //  .php2MySqlTime($sd)."' and '". php2MySqlTime($ed)."'";    $sql = "SELECT jqcalendar.*, NombreSucursal, NombreSalon, NombreMateria, NombreNivel, horario.Inicio, horario.Final, concat_WS(' ', Nombres_PRO, Apellido1_PRO) AS NombreProfesor    FROM jqcalendar     JOIN sucursal ON jqcalendar.Sede = sucursal.IdSucursal AND sucursal.EstadoSucursal = 1    JOIN salon ON jqcalendar.Salon = salon.IdSalon AND salon.Estado = 1     JOIN materia ON jqcalendar.Materia = materia.IdMateria AND materia.Estado = 1     JOIN nivel ON jqcalendar.Nivel = nivel.IdNivel AND nivel.Estado = 1    JOIN horario ON jqcalendar.Horario = horario.IdHorario  AND horario.Estado = 1    JOIN profesores ON jqcalendar.Profesor = profesores.IdProfesor  AND profesores.Estado_PRO = 1    WHERE starttime between '".php2MySqlTime($sd)."' AND '". php2MySqlTime($ed)."' $condi ORDER BY desde, NombreNivel, NombreMateria ;";        $handle = mysql_query($sql);    //echo $sql;    while ($row = mysql_fetch_object($handle)) {      //$ret['events'][] = $row;      //$attends = $row->AttendeeNames;      //if($row->OtherAttendee){      //  $attends .= $row->OtherAttendee;      //}      //echo $row->StartTime;      $ret['events'][] = array(        $row->Id,        $row->NombreNivel,        php2JsTime(mySql2PhpTime($row->StartTime)),        php2JsTime(mySql2PhpTime($row->EndTime)),        $row->NombreMateria,        0, //more than one day event        //$row->InstanceType,        0,//Recurring event,        $row->NombreProfesor,        1,//editable        $row->NombreSucursal,         ''//$attends      );    }	}catch(Exception $e){     $ret['error'] = $e->getMessage();  }  return $ret;}function listCalendar($day, $type){  $phpTime = js2PhpTime($day);  //echo $phpTime . "+" . $type;  switch($type){    case "month":      $st = mktime(0, 0, 0, date("m", $phpTime), 1, date("Y", $phpTime));      $et = mktime(0, 0, -1, date("m", $phpTime)+1, 1, date("Y", $phpTime));      break;    case "week":      //suppose first day of a week is monday       $monday  =  date("d", $phpTime) - date('N', $phpTime) + 1;      //echo date('N', $phpTime);      $st = mktime(0,0,0,date("m", $phpTime), $monday, date("Y", $phpTime));      $et = mktime(0,0,-1,date("m", $phpTime), $monday+7, date("Y", $phpTime));      break;    case "day":      $st = mktime(0, 0, 0, date("m", $phpTime), date("d", $phpTime), date("Y", $phpTime));      $et = mktime(0, 0, -1, date("m", $phpTime), date("d", $phpTime)+1, date("Y", $phpTime));      break;  }  //echo $st . "--" . $et;  return listCalendarByRange($st, $et);}function updateCalendar($id, $st, $et){  $ret = array();  try{    $db = new DBConnection();    $db->getConnection();    $sql = "update `jqcalendar` set"      . " `starttime`='" . php2MySqlTime(js2PhpTime($st)) . "', "      . " `endtime`='" . php2MySqlTime(js2PhpTime($et)) . "' "      . "where `id`=" . $id;    //echo $sql;		if(mysql_query($sql)==false){      $ret['IsSuccess'] = false;      $ret['Msg'] = mysql_error();    }else{      $ret['IsSuccess'] = true;      $ret['Msg'] = 'Actualizado registro Correctamente';    }	}catch(Exception $e){     $ret['IsSuccess'] = false;     $ret['Msg'] = $e->getMessage();  }  return $ret;}//function updateDetailedCalendar($id, $st, $et, $sub, $ade, $dscr, $loc, $color, $tz){function updateDetailedCalendar($id, $st, $et, $sede, $profesor, $salon, $horario, $nivel, $materia){  $ret = array();  try{        // Para colocar la hora de acuerdo al horario seleccionado        include_once('../../Connections/cnn_kn.php');         mysqli_select_db($cnn_kn, $database_cnn_kn);        $query_rs_tipo_clase = "SELECT IdClase, StartTime, EndTime FROM jqcalendar WHERE Id = $id;";        $rs_tipo_clase = mysqli_query($cnn_kn,$query_rs_tipo_clase) or die(mysqli_error()."$query_rs_tipo_clase");        mysqli_set_charset($cnn_kn,"utf8");        $row_rs_tipo_clase = mysqli_fetch_assoc($rs_tipo_clase);        $totalRows_rs_tipo_clase = mysqli_num_rows($rs_tipo_clase);        $cIdClase = $row_rs_tipo_clase['IdClase'];         $st = substr($row_rs_tipo_clase['StartTime'],0,10);        $et = substr($row_rs_tipo_clase['EndTime'],0,10);        mysqli_free_result($rs_tipo_clase);         mysqli_select_db($cnn_kn, $database_cnn_kn);        $query_rs_tipo_hora = "SELECT Inicio, Final FROM horario WHERE IdHorario = $horario AND Estado = 1;";        $rs_tipo_hora = mysqli_query($cnn_kn,$query_rs_tipo_hora) or die(mysqli_error()."$query_rs_tipo_hora");        mysqli_set_charset($cnn_kn,"utf8");        $row_rs_tipo_hora = mysqli_fetch_assoc($rs_tipo_hora);        $totalRows_rs_tipo_hora = mysqli_num_rows($rs_tipo_hora);        $hInicio = $row_rs_tipo_hora['Inicio'];        $hFinal = $row_rs_tipo_hora['Final'];        mysqli_free_result($rs_tipo_hora);           $st = $st.' '.$hInicio ;        $et = $et.' '.$hFinal ;        include_once('../../Connections/cnn_kn.php');        //IdEvento = '$st', desde = '$st', hasta ='$et'        $updSQL = "UPDATE clases SET Sede = $sede, Profesor = $profesor, Salon = $salon, Horario = $horario, Nivel = $nivel, Materia = $materia WHERE IdClase = $cIdClase;";        mysqli_select_db($cnn_kn, $database_cnn_kn);        $Result1 = mysqli_query($cnn_kn, $updSQL) or die(mysqli_error()."Err269....$updSQL<br>");         //echo "upd.....$updSQL";      $db = new DBConnection();      $db->getConnection();      $sql = "UPDATE `jqcalendar` SET"        //. " `starttime`='" . php2MySqlTime(js2PhpTime($st)) . "', "        //. " `endtime`='" . php2MySqlTime(js2PhpTime($et)) . "', "        . " `starttime`='" . mysql_real_escape_string($st) . "', "        . " `endtime`='" . mysql_real_escape_string($et) . "', "        . " `sede`='" . mysql_real_escape_string($sede) . "', "        . " `profesor`='" . mysql_real_escape_string($profesor) . "', "        . " `salon`='" . mysql_real_escape_string($salon) . "', "        . " `horario`='" . mysql_real_escape_string($horario) . "', "        . " `nivel`='" . mysql_real_escape_string($nivel) . "', "        . " `materia`='" . mysql_real_escape_string($materia) . "' "        . " WHERE `id`=" . $id;    //echo $sql;		if(mysql_query($sql)==false){      $ret['IsSuccess'] = false;      $ret['Msg'] = mysql_error();    }else{      $ret['IsSuccess'] = true;      $ret['Msg'] = 'Actualizado Correctamente';    }	}catch(Exception $e){     $ret['IsSuccess'] = false;     $ret['Msg'] = $e->getMessage();  }  return $ret;}function removeCalendar($id){  $ret = array();  try{    $db = new DBConnection();    $db->getConnection();    $sql = "delete from `jqcalendar` where `id`=" . $id;		if(mysql_query($sql)==false){      $ret['IsSuccess'] = false;      $ret['Msg'] = mysql_error();    }else{      $ret['IsSuccess'] = true;      $ret['Msg'] = 'Borrado Correctamente';    }	}catch(Exception $e){     $ret['IsSuccess'] = false;     $ret['Msg'] = $e->getMessage();  }  return $ret;}header('Content-type:text/javascript;charset=UTF-8');$method = $_GET["method"];if(isset($_GET['stpartdate'])) {     $start =  $_GET["stpartdate"];    //$start = date_format($start, 'd/m/Y H:i:s');    //$start = php2MySqlTime(js2PhpTime($start));    //$start = substr($start,0,10);    }switch ($method) {    case "add":        //$ret = addCalendar($_POST["CalendarStartTime"], $_POST["CalendarEndTime"], $_POST["CalendarTitle"], $_POST["IsAllDayEvent"]);    $ret = addCalendar($_POST["CalendarStartTime"], $_POST["CalendarEndTime"], $_POST["CalendarTitle"], $_POST["sede"], $_POST["profesor"], $_POST["salon"], $_POST["horario"], $_POST["nivel"], $_POST["materia"]);        break;    case "list":        $ret = listCalendar($_POST["showdate"], $_POST["viewtype"]);        break;    case "update":        //$ret = updateCalendar($_POST["calendarId"], $_POST["CalendarStartTime"], $_POST["CalendarEndTime"]);          $ret = updateCalendar($_POST["calendarId"], $_POST["CalendarStartTime"], $_POST["CalendarEndTime"], $_POST["sede"], $_POST["profesor"], $_POST["salon"], $_POST["horario"], $_POST["nivel"], $_POST["materia"]);        break;     case "remove":        $ret = removeCalendar( $_POST["calendarId"]);        break;    case "adddetails":                //$st = $_POST["stpartdate"] . " " . $_POST["stparttime"];                //$et = $_POST["etpartdate"] . " " . $_POST["etparttime"];                $st = $start; //. " 00:00:00";  //$_POST["stpartdate"];        $et = $start; //. " 00:00:00";   //$_POST["stpartdate"];        if(isset($_GET["id"]))        {            $ret = updateDetailedCalendar($_GET["id"], $st, $et,               $_POST["sede"], $_POST["profesor"], $_POST["salon"], $_POST["horario"], $_POST["nivel"], $_POST["materia"]);                //$_POST["Subject"], isset($_POST["IsAllDayEvent"])?1:0, $_POST["Description"],                 //$_POST["Location"], $_POST["colorvalue"], $_POST["timezone"]);        }        else        {            $ret = addDetailedCalendar($st, $et,                                 $_POST["sede"], $_POST["profesor"], $_POST["salon"], $_POST["horario"], $_POST["nivel"], $_POST["materia"]);            //    $_POST["Subject"], isset($_POST["IsAllDayEvent"])?1:0, $_POST["Description"],             //    $_POST["Location"], $_POST["colorvalue"], $_POST["timezone"]);        }                break; }echo json_encode($ret); ?>